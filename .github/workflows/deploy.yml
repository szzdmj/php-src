name: Build PHP WASM for Cloudflare Workers

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted, Linux, x64]
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Emscripten SDK
        run: |
          git clone https://github.com/emscripten-core/emsdk.git
          cd emsdk
          ./emsdk install latest
          ./emsdk activate latest

      - name: Build libxml2 with Emscripten
        run: |
          source ./emsdk/emsdk_env.sh
          git clone https://gitlab.gnome.org/GNOME/libxml2.git
          cd libxml2
          git checkout v2.9.14

          # Generate configure script if missing
          test -x configure || ./autogen.sh

          # Configure with --without-zlib
          emconfigure ./configure \
            --host=wasm32-unknown-emscripten \
            --disable-shared \
            --without-python \
            --without-zlib \
            --without-lzma \
            --disable-dependency-tracking \
            --prefix=$(pwd)/build

          emmake make -j$(nproc)
          emmake make install
          cd ..

      - name: Export oniguruma paths for PHP
        run: |
          echo "ONIG_CFLAGS=-I$GITHUB_WORKSPACE/oniguruma/build/include" >> $GITHUB_ENV
          echo "ONIG_LIBS=$GITHUB_WORKSPACE/oniguruma/build/lib/libonig.a" >> $GITHUB_ENV

      - name: Clean previous builds
        run: |
          git clean -xfd || true
          if [ -f Makefile ]; then make clean || true; fi
          rm -rf config.cache autom4te.cache || true

      - name: Generate configure script
        run: |
          source ./emsdk/emsdk_env.sh
          ./buildconf --force

      - name: Configure PHP with Emscripten
        env:
          LIBXML_CFLAGS: ${{ env.LIBXML_CFLAGS }}
          LIBXML_LIBS: ${{ env.LIBXML_LIBS }}
          ONIG_CFLAGS: ${{ env.ONIG_CFLAGS }}
          ONIG_LIBS: ${{ env.ONIG_LIBS }}
          CFLAGS: "-O2 -sALLOW_MEMORY_GROWTH=1 -sENVIRONMENT=web,worker -sEXPORTED_FUNCTIONS=[_main,_php_embed_init,_php_embed_shutdown] -sEXPORTED_RUNTIME_METHODS=[cwrap,ccall]"
        run: |
          set -x
          source ./emsdk/emsdk_env.sh
          export CC="$EMSDK/upstream/emscripten/emcc"
          export CXX="$EMSDK/upstream/emscripten/em++"
          export ac_cv_header_minix_config_h=no
          export ac_cv_file__dev_ptmx=no
          export ac_cv_file__dev_ptc=no
          export ac_cv_func_malloc_0_nonnull=yes
          export ac_cv_func_realloc_0_nonnull=yes
          export ac_cv_func_opendir=yes
          export ac_cv_func_closedir=yes
          emconfigure ./configure \
            --host=wasm32-unknown-emscripten \
            --disable-all \
            --disable-cli \
            --disable-cgi \
            --disable-phpdbg \
            --disable-zlib \
            --disable-curl \
            --without-pear \
            --with-libxml \
            --enable-embed=static \
            --enable-simplexml \
            --enable-xml \
            --enable-session \
            --enable-mbstring \
            --enable-json \
            --enable-tokenizer \
            --enable-filter \
            --enable-posix \
            LIBXML_CFLAGS="$LIBXML_CFLAGS" \
            LIBXML_LIBS="$LIBXML_LIBS" \
            ONIG_CFLAGS="$ONIG_CFLAGS" \
            ONIG_LIBS="$ONIG_LIBS" 
            set +x
